#!/bin/bash

IP=$(cat /etc/IP)

# Crear directorio si no existe
if [ ! -d /etc/SSHPlus/usuariotoken ]; then
    mkdir -p /etc/SSHPlus/usuariotoken
fi

# Mostrar encabezado
tput setaf 7 ; tput setab 4 ; tput bold ; printf '%30s%s%-15s\n' "CREAR USUARIO TOKEN ID" ; tput sgr0
echo ""

# Verificar tokens activos
if [ "$(ls -A /etc/SSHPlus/usuariotoken)" ]; then
    echo -e "\033[1;32mTOKEN ID ACTIVOS!\033[1;37m"
else
    echo -e "\033[1;31mSIN TOKEN ID ACTIVOS!\033[0m"
fi
echo ""

# Listar tokens
for token in $(ls /etc/SSHPlus/usuariotoken | sort | sed 's/.sh//g'); do
    echo "$token"
done
echo ""

# Leer nombre de usuario
echo -ne "\033[1;32mNombre de usuario\033[1;37m: "
read nome
if [[ -z $nome ]]; then
    tput setaf 7 ; tput setab 1 ; tput bold
    echo ""
    echo "Nombre vacío o no válido."
    echo ""
    tput sgr0
    exit 1
fi

# Verificar si el usuario ya existe
if grep -Fxq "$nome" /etc/passwd; then
    tput setaf 7 ; tput setab 1 ; tput bold
    echo ""
    echo "Este usuario ya existe."
    echo ""
    tput sgr0
    exit 1
fi

# Leer contraseña
echo -ne "\033[1;32mContraseña\033[1;37m: "
read -s pass
echo ""
if [[ -z $pass ]]; then
    tput setaf 7 ; tput setab 1 ; tput bold
    echo ""
    echo "Contraseña vacía o no válida."
    echo ""
    tput sgr0
    exit 1
fi

# Leer límite
echo -ne "\033[1;32mLímite\033[1;37m: "
read limit
if [[ -z $limit ]]; then
    tput setaf 7 ; tput setab 1 ; tput bold
    echo ""
    echo "Límite vacío o no válido."
    echo ""
    tput sgr0
    exit 1
fi

# Leer días
echo -ne "\033[1;32mDías \033[1;33m(\033[1;31mEjemplo: \033[1;37m31\033[1;33m)\033[1;37m: "
read dias
if [[ -z $dias ]]; then
    tput setaf 7 ; tput setab 1 ; tput bold
    echo ""
    echo "Días vacío o no válido."
    echo ""
    tput sgr0
    exit 1
fi

# Configurar usuario
final=$(date "+%Y-%m-%d" -d "+$dias days")
gui=$(date "+%d/%m/%Y" -d "+$dias days")
pass_hash=$(perl -e 'print crypt($ARGV[0], "pass")' $pass)

useradd -e $final -M -s /bin/false -p $pass_hash $nome >/dev/null 2>&1
echo "$pass" > /etc/SSHPlus/senha/$nome
echo "$nome $dias" >> /root/usuarios.db

# Mostrar información del usuario
clear
echo -e "\E[44;1;37m     Usuario Token ID creado con éxito...     \E[0m"
echo ""
echo -e "\033[1;32mIP:\033[1;37m $IP"
echo -e "\033[1;32mToken ID:\033[1;37m $nome"
echo -e "\033[1;32mContraseña:\033[1;37m $pass"
echo -e "\033[1;32mLímite:\033[1;37m $limit"
echo -e "\033[1;32mVencimiento:\033[1;37m $gui"
exit