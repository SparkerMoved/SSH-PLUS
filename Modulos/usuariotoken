#!/bin/bash

IP=$(cat /etc/IP)
cor1='\033[41;1;37m'
cor2='\033[44;1;37m'
scor='\033[0m'

[[ ! -e /usr/lib/sshplus ]] && exit 0
tput setaf 7;tput setab 4;tput bold;printf '%30s%s%-15s\n' "CREAR USUARIO TOKEN ID";tput sgr0

echo -ne "\033[1;32mğŸ—£ï¸ TOKEN ID:\033[1;37m ";read username
[[ -z $username ]] && {
	echo -e "\n${cor1}Token vacÃ­o o no vÃ¡lido!${scor}\n"
	exit 1
}
[[ "$(grep -wc $username /etc/passwd)" != '0' ]] && {
	echo -e "\n${cor1}Este token ya existe, intente con otro token!${scor}\n"
	exit 1
}
sizemin=$(echo ${#username})
[[ $sizemin -lt 2 ]] && {
	echo -e "\n${cor1}Ingresaste un token que es demasiado corto${scor}"
	echo -e "${cor1}utilizar al menos 2 caracteres!${scor}\n"
	exit 1
}
sizemax=$(echo ${#username})
[[ $sizemax -gt 25 ]] && {
	echo -e "\n${cor1}Ingresaste un token demasiado largo"
	echo -e "${cor1}utilizar un mÃ¡ximo de 25 caracteres!${scor}\n"
	exit 1
}
echo -ne "\033[1;32mğŸ”‘ CONTRASEÃ‘A:\033[1;37m ";read password
[[ -z $password ]] && {
	echo -e "\n${cor1}ContraseÃ±a vacÃ­a o no vÃ¡lida!${scor}\n"
	exit 1
}
sizepass=$(echo ${#password})
[[ $sizepass -lt 4 ]] && {
	echo -e "\n${cor1}Â¡ContraseÃ±a corta!, utiliza al menos 4 caracteres${scor}\n"
	exit 1
}
echo -ne "\033[1;32mâŒ› DÃAS PARA VENCER:\033[1;37m ";read dias
[[ -z $dias ]] && {
	echo -e "\n${cor1}NÃºmero de dÃ­as vacÃ­os!${scor}\n"
	exit 1
}
[[ ${dias} != ?(+|-)+([0-9]) ]] && {
	echo -e "\n${cor1}Ingresaste un nÃºmero de dÃ­as no vÃ¡lido!${scor}\n"
	exit 1
}
[[ $dias -lt 1 ]] && {
	echo -e "\n${cor1}El nÃºmero debe ser mayor que cero.!${scor}\n"
	exit 1
}
echo -ne "\033[1;32mğŸ“² LIMITE DE CONEXIONES:\033[1;37m ";read sshlimiter
[[ -z $sshlimiter ]] && {
	echo -e "\n${cor1}Dejaste el lÃ­mite de conexiÃ³n vacÃ­o!${scor}\n"
	exit 1
}
[[ ${sshlimiter} != ?(+|-)+([0-9]) ]] && {
	echo -e "\n${cor1}Ingresaste un nÃºmero no vÃ¡lido de conexiones!${scor}\n"
	exit 1
}
[[ $sshlimiter -lt 1 ]] && {
	echo -e "\n${cor1}El nÃºmero de conexiones simultÃ¡neas debe ser mayor que cero.!${scor}\n"
	exit 1
}
final=$(date "+%Y-%m-%d" -d "+$dias days")
gui=$(date "+%d/%m/%Y" -d "+$dias days")
pass=$(perl -e 'print crypt($ARGV[0], "password")' $password)
useradd -e $final -M -s /bin/false -p $pass $username >/dev/null 2>&1 &
echo "$password" >/etc/SSHPlus/senha/$username
echo "$username $sshlimiter" >>/root/usuarios.db


clear
echo -e "\E[44;1;37m======ğŸ¦¸DATOS DE ACCESOğŸ¦¸â€â™€ï¸======\E[0m"
echo -e "\033[1;32m ğŸ—£ï¸TOKEN ID: \033[1;37m$username"
echo -e "\033[1;32m ğŸ”‘CONTRASEÃ‘A: \033[1;37m$password"
echo -e "\033[1;32m âŒ›EXPIRA EN: \033[1;37m$gui"
echo -e "\033[1;32m ğŸ“²LIMITE DE CONEXION: \033[1;37m$sshlimiter"
